---
title: 外部ライブラリの使用
---

配布されたプログラムを利用する方法を知っておきましょう。


## javac,javaコマンドでのjarファイルの参照

Javaのプログラムをターミナル等からコマンドを使用してビルド・実行するには、以下のコマンドを使用します。

```bash
$ javac MyClass.java
$ java MyClass
```

Javaの標準APIのみを使用したプログラムならこれだけで大丈夫です。これ以外に、他の人が作成したクラスライブラリを含めた状態で実行するには、どのようにすればよいでしょうか？

そこで重要なキーワードが、**クラスパス** と呼ばれるクラスファイルを読み込む場所の指定です。

クラスパスとは、Javaアプリケーションを実行するときに、Java Virtual Machine（以下JVM）がどのパス（ファイルもしくはディレクトリの場所）からクラスファイル（.classファイル : Javaのコンパイル済みプログラムもしくは、パッケージングされたjarファイル）を読み込めばよいかを指定するためのものです。  
基本的には、JVMは、アプリケーションを実行するために必要なクラスファイルをクラスパスに指定されたパスから読み込みます。

通常、クラスパスは`javac`,`java`コマンドが発行されるカレントディレクトリ（現在作業中のディレクトリ:Terminalの$以前に書いてある場所）と、Java標準APIに対して指定されています。

そこで、追加して実行する場合は以下の2つの方法が考えられます。

1. プロジェクト内で使用しているクラスファイルを既存のクラスパスの場所に配置する
2. プロジェクト内で使用しているクラスファイルを保管してある場所をクラスパスとして指定する
    + `~/java/lib`にclassファイルがあるとすると、`$ java -cp ~/java/lib Hoge`のように、`-cp`オプションを指定して実行できます。
    + 日本語での説明を加えると、`$ java -cp 参照するクラスのあるパス 実行するクラス名` という形式です。


またjarファイルに関して、`mylib.jar`というjarファイルが現在のディレクトリにあるとします。
このjarファイルを使ってJavaのプログラムをコンパイルするには、以下のようなコマンドを使います。

```bash
javac -cp .:mylib.jar MyProgram.java
```

このコマンドでは、`.`（現在のディレクトリ）と`mylib.jar`をクラスパスとして指定しています。
同様に、Javaのプログラムを実行するには、以下のようなコマンドを使います。

```bash
java -cp .:mylib.jar MyProgram
```

この場合も、`.`（現在のディレクトリ）と`mylib.jar`をクラスパスとして指定しています。

ただし、上記のコマンドはUnix系のシステム（LinuxやMac OS）で使用する場合のものです。
Windowsでは、パスの区切り文字に`;`（セミコロン）を使うので、以下のようになります。

```bash
javac -cp .;mylib.jar MyProgram.java
java -cp .;mylib.jar MyProgram
```

コマンドでの実行時に、クラスパスを指定する方法について説明しました。
以降は、IDEを活用する場合について解説します。

----

## IntelliJ IDEAで外部ライブラリを読み込ませる

### 前提知識としてのJavaビルドツール

プログラミング言語には大抵の場合、ソースコードをビルドする際に必要なライブラリファイルを管理するツールや、設定情報を一括管理したりするためのビルドツールと呼ばれるものがあります。

Javaには、Ant,Maven,Gradleなどが有名所で存在しており、それぞれインストールして使用する他に、IntelliJ IDEAを始めとしたIDEに標準搭載されています。
IntelliJ IDEAの標準的なJavaプロジェクトを作成すると、プロジェクトはAntベースの独自方法によって管理されています。

これらのビルドツールは、基本的な動作についてはほぼ同じで、ライブラリの取得方法や設定ファイルの書き方が異なっていたりします。

ビルドツールが、`javac`や`java`コマンドなどの実行タイミングや、事前準備をかわりに行ってくれているイメージでよいと思います。

### Jarファイルをプロジェクトに読み込ませる

IntelliJ IDEAでJarファイルを依存関係ライブラリとして追加することも可能です。
任意の場所にライブラリとして読み込ませたいJarファイルを配置して、以下の手順にしたがってください。

1. プロジェクトを開いてください。
2. 「ファイル（File）」メニューから「プロジェクト構造（Project Structure）」（または `Ctrl + Alt + Shift + S` を押す）を選択します。
3. 左側のメニューから「モジュール（Modules）」をクリックします。
4. 中央の「依存関係（Dependencies）」タブをクリックします。
5. 右側の「+」ボタンをクリックして、「JARまたはディレクトリ（JARs or directories...）」を選択します。
6. 追加したいjarファイルをファイルシステムから探して選択し、「OK」をクリックします。
7. 「適用（Apply）」をクリックして変更を保存し、「OK」をクリックしてダイアログを閉じます。

これで、選択したJarファイルがプロジェクトの依存関係ライブラリとして追加されます。
このjarファイルの中にあるクラスやメソッドは、プロジェクトのどの部分からもアクセスできるようになります。

JavaDocはJarには含まれず同時に読み込まれません。
別途Jarのライブラリ用のJavaDocを用意して、「プロジェクト構造」の「モジュール」にて、「パス」のタブを選び、「JavaDoc」の項目から追加してください。

----

# 補足資料（※ある程度経験がある人向け）
## Maven

この資料で紹介するのは、Mavenについてのみです。
ですが、GradleはAndroidアプリ開発でよく使用されるビルドツールですし、作成するアプリケーションによってビルドツールを何にするか、という点も昨今の開発には必須の作業になります。

Mavenはプロジェクトをビルドする際に、ビルドに必要な依存ライブラリをインターネットから取得して自身のプロジェクトに組み込む形式を採っています。
もちろん、インターネットからライブラリをダウンロードする関係上、インターネットに接続している状態でビルドを行う必要があります。
ｓ
プロジェクトで使用するライブラリを依存ライブラリといいます。
依存ライブラリは、`POM.xml`と言う名前のXMLファイル内の`dependencies`の項目によって管理されており、それをメンテナンスすれば、必要なライブラリをわざわざ自分でダウンロードしてプロジェクトに読み込みさせる必要はありません。

この資料では、とりあえずMavenでプロジェクトを作り、依存関係を確認、ビルドして実行までを確認します。


### Mavenのインストール

Mavenは、IntelliJ IDEAで開発を行う場合は、IntelliJ IDEA内部に含まれていますので別途インストールする必要はありません。

もしIDEを使用しないで別途インストールする必要がある方は、以下のリンク先からダウンロードできます。（この講義で最初にインストールしたSDKManからでもダウンロードとインストールが可能です。）

- [Maven – Download Apache Maven](https://maven.apache.org/download.cgi)

----

## ビルドツールにMavenを指定してプロジェクトを作る

Mavenのプロジェクトサンプルとして、microservicesフレームワークのsparkを使ってみましょう。  
(※クラスタコンピューティングフレームワークにApache Sparkというものがありますが、そちらではなくJava/Kotlin用のラムダ構文対応Webフレームワークのsparkです。)

- [Spark Framework: An expressive web framework for Kotlin and Java](http://sparkjava.com/)

### プロジェクトの作成

ビルドシステムをMavenに変えてプロジェクトを作成します。

![](/docs/06/SCR-20220625-fmy2.png)

ビルドシステムを変えると、ビルドシステムに沿ったプロジェクトが生成されます。Mavenの場合は、IntelliJ IDEAと比べてソースコードファイルの保存場所が若干変わります。

### 依存ライブラリを設定

プロジェクトが作成されたら、`POM.xml`を開きます。

依存関係にSparkを追加します。

参考にする資料は以下のリンク先です。

- [Documentation - Spark Framework: An expressive web framework for Kotlin and Java](http://sparkjava.com/documentation#getting-started)

`pom.xml`の`<project>`タグ内の直下に以下の依存関係を追加しましょう。

```xml
    <dependencies>
        <dependency>
            <groupId>com.sparkjava</groupId>
            <artifactId>spark-core</artifactId>
            <version>2.9.3</version>
        </dependency>
    </dependencies>
```

保存したら、依存ライブラリのダウンロードのためにMavenプロジェクトの再ロードを行います。
以下の画像を参考に、`pom.xml`を右クリック→`Maven`→`プロジェクトの再ロード`を選択し、少し待ちます。

![](/docs/06/sc-maven.png)

また、「ソースコードおよびドキュメントのダウンロード」を選ぶと、プロジェクト内にライブラリだけでなく中身のソースコードやJavaDocまでダウンロードが可能です。
ライブラリのバグに当たってしまった場合は、ライブラリ内のソースコードが必要になることがありますので、適宜使ってください。

### コードを書く

作成されたパッケージ以下に、通常のJavaクラス`Main.java`を作成し、以下のコードを貼り付けます。


```java
import static spark.Spark.*;

public class Main {
    public static void main(String[] args) {
        get("/hello", (req, res) -> "Hello World");

        // サーバー停止のためのリクエスト受付
        get("/stop", (req, res) -> {
          stop();
          return "Server Stoped...";
        });
    }
}
```

### 動作確認

`Main.java`をメインクラスとして、プロジェクトを実行します。

Loggingライブラリが正常に読み込みできないエラーが以下のように出ますが、実行自体は成功しているはずです。

```bash
SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder
```

このエラーを回避するには、以下の依存ライブラリをpom.xmlに追記します。

```xml
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
            <version>1.7.21</version>
        </dependency>
```

Logger関連でエラーが出ていても実行できているはずなので、以下のURLにアクセスして、Hello Worldが表示されるかを確認します。

[http://localhost:4567/hello](http://localhost:4567/hello)


### サーバーの停止

Sparkで作成したサーバーは、基本的に起動したらそのまま起動したままになります。  
サーバーを停止するためには、`stop()`メソッドを呼ばなければサーバーを停止できません。（プロセスごと落とすとJavaVMも道連れになりかねないです）

↑のサンプルソースでは、`stop()`を呼ぶための処理も追加しています。  
（クライアントがわからサーバー停止できるコードなので、本来は使っちゃダメなコードです。）

下のURLにアクセスしてサーバーを停止しましょう。

[http://localhost:4567/stop](http://localhost:4567/stop)


※コードを書き換えてビルドして実行する場合に、サーバー停止しないとポート番号が使えないため実行できません。


### Mavenの依存ライブラリについて

この資料では、Webアプリケーション用のライブラリを紹介していますが、ファイル処理の時に紹介している`apache-commons-csv`や`opencsv`なども同様、簡単にライブラリを追加できます。

- [Commons CSV – Home](https://commons.apache.org/proper/commons-csv/)
- [opencsv –](http://opencsv.sourceforge.net/)

ライブラリの配布サイトを見ると、dependencyのXML記述があるはずです。
これを探してPOM.xmlに記述するだけで、インターネットからライブラリをダウンロードしてくれます。
通常のプロジェクト作成では、ライブラリを使用したい場合に以下の手順が発生します。

1. 使いたい外部ライブラリのjarファイルをダウンロード
2. プロジェクトディレクトリに配置
3. そのjarファイルに対してクラスパス設定

こういった手順を廃止できるだけでも間違いが発生しづらくなり、安心して外部ライブラリが使えます。
チーム開発を行う場合でも、プロジェクトディレクトリとpom.xmlを共有できれば事前に使用するライブラリを統一することができるなどのメリットしかありません。


----


## Oracleの開発しているmicroservicesフレームワーク

また、別のMavenプロジェクトの始め方として、Archetypeを使用する方法も紹介しておきます。

参考にOracleの開発しているWebと連携するアプリ作成時のバックエンドとなりえるmicroservicesフレームワークである「Helidon」を使ってみましょう。

- [Helidon](https://helidon.io/#/)

IntelliJ IDEAの新規プロジェクトの画面にて、「Maven Archetype」を選び、以下の画像を参考にプロジェクトを作成します。

Helidonには、SEとMPがあり、それぞれ以下のような説明があります。

- SE : Java SEのリアクティブストリーム、非同期プログラミング、関数型プログラミング、フルエントスタイルAPIを包含するコンパクトなツールキットです
- MP : Jakarta EEコミュニティがポータブルな方法でマイクロサービスを実行できるようにするためのEclipse MicroProfileランタイムです

どちらでもよいのですが、コードの書き方が大きく異なるため、どちらも試してみましょう。
この資料では、Archetypeに「io.helidon.archetypes:helidon-quickstart-se」を選んでいます。

![](/docs/06/SCR-20220624-t21-2.png)

プロジェクトを作成し終えたら、依存関係のライブラリをインターネットから読み込む手順が自動的に始まり、それが終わるとプロジェクトのソースコードなどを読めたり変更を加えたりできるようになります。

また、初回のビルドの際に、`POM.xml`に記載されたすべてのライブラリをダウンロードする手順が自動的に始まりますので、とにかく時間が掛かります。  
（**講義内でみんなが一斉に行うと、インターネットアクセスが集中してしまい予期せぬ不具合が発生しかねません。お家に帰ってから試しましょう。**）

### 動作確認

`Main.java`をメインクラスとして実行します。

起動したら、`GreetService.java`のコメントにあるように動作確認ができます。

`curl`コマンドを使うとコマンドラインからHTTPのリクエストが投げられますが、ここではいったん、以下のURLにアクセスしてみてください。

[http://localhost:8080/greet/Joe](http://localhost:8080/greet/Joe)


```
{"message":"Hello Joe!"}
```


上記のようなJSONデータが表示されます。

このJSONデータは、プロジェクトの`Main.java`や`GreetService.java`で生成されていますので、どこでそのデータが生成されているかソースコードを調べてみましょう。

これを使うことで、ネットワーク上にAPIを持たせることができ、アプリ作成時にも活用できるようになります。
こういったフレームワークは他にもたくさんありますが、詳細な説明は割愛します。

----

## ライブラリの探し方

Googleなどの検索エンジンで、「`Java ライブラリ 〇〇`」〇〇にやりたいことを書いて調べてみましょう。

ライブラリの名前がわかったら、以下のサイトでMavenリポジトリの存在を確認します。見つからなければ、jarファイルをダウンロードするしかないのではないかと思われます。

- [The Central Repository Search Engine](https://search.maven.org/)

あとは、ライブラリの公式ドキュメントをよく読み、やりたいことを実現できるように頑張ってください。

